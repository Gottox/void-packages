# Template file for 'vboot-utils'
pkgname=vboot-utils
version=92.13982
revision=1
_version=${version/./-}
archs="x86_64* i686* aarch64* arm*"
create_wrksrc=yes
build_style=gnu-makefile
make_use_env=yes
hostmakedepends="pkg-config"
makedepends="openssl-devel libuuid-devel zlib-devel"
short_desc="Verified boot kernel utilities"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="BSD-3-Clause"
homepage="https://chromium.googlesource.com/chromiumos/platform/vboot_reference.git"
# Using github mirror because upstream does not have stable checksums.
distfiles="https://github.com/coreboot/vboot/archive/refs/heads/release-R${_version}.B.tar.gz"
checksum=84ce04a9a65c4ec3f08fcf76576a0decde38c72596e350b2bd95dfc95b05f62f
# 2crypto specifies a section for some variables, which lead to text relocations in the binary
# let's play it safe and disable PIE
nopie=yes

case $XBPS_TARGET_MACHINE in
	x86_64*) _arch=x86_64 ;;
	i686*) _arch=x86 ;;
	arm*|aarch64*) _arch=arm ;;
	*) broken="This package doesn't have a configuration for this target" ;;
esac
make_build_args="ARCH=${_arch} WERROR="

if [ "$XBPS_TARGET_LIBC" = musl ]; then
	makedepends+=" musl-fts-devel"
	export LDLIBS="-lfts"
fi

post_install() {
	vmkdir usr/share/vboot
	vcopy tests/devkeys usr/share/vboot/devkeys
	vlicense LICENSE
}
